[[r_setting_up_server]]
=== Configurando o servidor

Vamos analisar como configurar acesso SSH no lado do servidor.
Nesse exemplo, você utilizará o método `authorized_keys` para autenticar seus usuários.
Também presumiremos que você está usando uma distribuição Linux padrão, como Ubuntu.
Primeiro, você cria um usuário `git` e um diretório `.ssh` para esse usuário.

[source,console]
----
$ sudo adduser git
$ su git
$ cd
$ mkdir .ssh && chmod 700 .ssh
$ touch .ssh/authorized_keys && chmod 600 .ssh/authorized_keys
----

Em seguida, você precisa adicionar algumas chaves SSH públicas de desenvolvedor ao arquivo `authorized_keus` do usuário git.
Vamos supor que você tem algumas chaves públicas confiáveis e que você salvou eles em arquivos temporários.
Novamente, as chaves públicas se parecem com algo assim:

[source,console]
----
$ cat /tmp/id_rsa.john.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCB007n/ww+ouN4gSLKssMxXnBOvf9LGt4L
ojG6rs6hPB09j9R/T17/x4lhJA0F3FR1rP6kYBRsWj2aThGw6HXLm9/5zytK6Ztg3RPKK+4k
Yjh6541NYsnEAZuXz0jTTyAUfrtU3Z5E003C4oxOj6H0rfIF1kKI9MAQLMdpGW1GYEIgS9Ez
Sdfd8AcCIicTDWbqLAcU4UpkaX8KyGlLwsNuuGztobF8m72ALC/nLF6JLtPofwFBlgc+myiv
O7TCUSBdLQlgMVOFq1I2uPWQOkOWQAHukEOmfjy2jctxSDBQ220ymjaNsHT4kgtZg2AYYgPq
dAv8JggJICUvax2T9va5 gsg-keypair
----

Basta adicioná-las ao arquivo `authorized_keys` do usuário `git` no diretório `.ssh`:

[source,console]
----
$ cat /tmp/id_rsa.john.pub >> ~/.ssh/authorized_keys
$ cat /tmp/id_rsa.josie.pub >> ~/.ssh/authorized_keys
$ cat /tmp/id_rsa.jessica.pub >> ~/.ssh/authorized_keys
----

Agora, você pode configurar um repositório vazio para eles rodando `git init` com a opção `--bare`, que inicializa um repositório sem nenhum diretório de trabalho:(((git commands, init, bare)))

[source,console]
----
$ cd /srv/git
$ mkdir project.git
$ cd project.git
$ git init --bare
Initialized empty Git repository in /srv/git/project.git/
----

Então, John, Josie ou Jessica podem enviar a primeira versão de seus projetos nesse repositório, adicionando-o como um projeto remoto e criando uma branch.
Note que alguém precisa acessar o shell da máquina e criar um repositório vazio toda vez que você quiser adicionar um projeto.
Vamos usar `gitserver` como o nome do host do servidor no qual você configurou seu usuário `git` e o repositório.
Se você estiver executando internamente e configurar um DNS para `gitserver` apontando para esse servidor, então você pode usar os comandos praticamente como estão (considerando que `myproject` seja um projeto existente com arquivos):

[source,console]
----
# on John's computer
$ cd myproject
$ git init
$ git add .
$ git commit -m 'initial commit'
$ git remote add origin git@gitserver:/srv/git/project.git
$ git push origin master
----

Apartir desse ponto, os outros podem cloná-lo e enviar alterações de volta com facilidade:

[source,console]
----
$ git clone git@gitserver:/srv/git/project.git
$ cd project
$ vim README
$ git commit -am 'fix for the README file'
$ git push origin master
----

Com esse método, você pode rapidamente configurar e executar um Servidor git de leitura/gravação para um pequeno grupo de desenvolvedores.

É importante notar que, atualmente, todos esses usuários também podem fazer login no servidor e acessar um shell como o usuário `git`.
Se você quiser restringir isso, você deve mudar o shell para alguma outra coisa no arquivo `passwd`.

Você pode facilmente restringir o usuário `git` para apenas realizar atividades do Git com uma ferramenta de shell limitada chamada `git-shell` que vem com o Git.
Se você configurar isso como o shell de login do seu usuário `git`, então o usuário `git` não pode ter acesso ao shell normal do seu servidor.
Para usar isso, especifique `git-shell` ao invés de bash ou csh para o shell de login do seu usuário.
Para isso, primeiro você precisa adicionar `git-shell` para `/etc/shells` se já não estiver lá:

[source,console]
----
$ cat /etc/shells   # see if `git-shell` is already in there.  If not...
$ which git-shell   # make sure git-shell is installed on your system.
$ sudo vim /etc/shells  # and add the path to git-shell from last command
----

Agora você pode editar o shell para um usuário utilizando `chsh <username>`:

[source,console]
----
$ sudo chsh git  # and enter the path to git-shell, usually: /usr/bin/git-shell
----

Agora, o usuário do Git só pode usar a conexão SSH para enviar e receber alterações em repositórios Git e não pode acessar o shell da máquina.
Se você tentar, verá uma mensagem rejeitando o login como esta:

[source,console]
----
$ ssh git@gitserver
fatal: Interactive git shell is not enabled.
hint: ~/git-shell-commands should exist and have read and execute access.
Connection to gitserver closed.
----

Agora, comandos de rede Git irão continuar funcionando bem, mas usuários não serão capazes de conseguir acesso ao shell.
Conforme indicado na saída, você pode configurar um diretório no diretório home do usuário `git` que customiza um pouco o comando `git-shell`
Por exemplo, você pode restringir os comandos que o servidor vai aceitar ou pode customizar a mensagem que usuários veem ao tentar acessar via SSH.
Execute `git help shell` para mais informações de como customizar o shell.(((git commands, help)))
